<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoomieRadar - Matches</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .match-card-container { width: 90%; max-width: 400px; position: relative; }
        .match-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); overflow: hidden; position: absolute; width: 100%; height: 500px; top: 0; transition: transform 0.5s, opacity 0.5s; cursor: grab; }
        .match-card.hidden { opacity: 0; transform: translateY(20px); }

        .card-image { width: 100%; height: 70%; object-fit: cover; }
        .card-info { padding: 15px; text-align: left; }
        .card-info h3 { margin: 0; color: #e75480; font-size: 1.5em; display: flex; justify-content: space-between; align-items: center; }
        .compatibility { color: #333; font-weight: 600; font-size: 1.1em; }
        .card-info p { margin: 5px 0; color: #666; font-size: 0.9em; }
        .card-info .hobbies { font-style: italic; font-size: 0.8em; color: #999; }
        .swipe-btns { display: flex; justify-content: space-around; padding: 20px 0; }
        .swipe-btns button { border: none; background: none; font-size: 3em; cursor: pointer; transition: transform 0.2s, color 0.2s; }
        .swipe-btns .like-btn { color: #4CAF50; }
        .swipe-btns .dislike-btn { color: #F44336; }
        .swipe-btns button:hover { transform: scale(1.1); }
        #no-matches { text-align: center; color: #666; font-size: 1.2em; display: none; }
    </style>
</head>
<body>
    <div class="match-card-container" id="card-container">
        <div id="no-matches">
            <i class='bx bx-search' style="font-size: 3em; color: #e75480;"></i>
            <p>No more potential roomies for now. Check back later!</p>
            <a href="/preferences.html" class="edit-btn">Review Preferences</a>
        </div>
    </div>

    <div class="swipe-btns">
        <button class="dislike-btn" onclick="performSwipe('left')"><i class='bx bx-x-circle'></i></button>
        <button class="like-btn" onclick="performSwipe('right')"><i class='bx bx-heart'></i></button>
    </div>

    <script>
        let matches = [];
        let currentMatchIndex = 0;
        const container = document.getElementById('card-container');
        const noMatchesDiv = document.getElementById('no-matches');

        // Function to create an HTML card for a match
        function createMatchCard(match) {
            const card = document.createElement('div');
            card.className = 'match-card';
            card.dataset.userId = match._id;

            // Simplified display: Profile Photo, Description, Bio, Hobbies
            card.innerHTML = `
                <img src="${match.profilePhoto}" alt="${match.username}" class="card-image">
                <div class="card-info">
                    <h3>
                        ${match.username}
                        <span class="compatibility">${match.compatibilityPercentage}% Compatible</span>
                    </h3>
                    <p style="font-weight: 600;">"${match.bio || 'No bio.'}"</p>
                    <p class="hobbies">Hobbies: ${match.hobbies && match.hobbies.length > 0 ? match.hobbies.join(', ') : 'None listed'}</p>
                    <a href="/chat.html?matchId=${match._id}" style="display: block; margin-top: 10px; color: #e75480; text-align: center;">
                        <i class='bx bxs-chat' style="font-size: 2em;"></i>
                    </a>
                </div>
            `;
            return card;
        }

        // Function to render the top card
        function renderTopCard() {
            container.innerHTML = '';
            if (matches.length === 0) {
                noMatchesDiv.style.display = 'block';
                return;
            }
            noMatchesDiv.style.display = 'none';

            // Render all cards, hiding all but the top one for stack effect
            for (let i = 0; i < matches.length; i++) {
                const match = matches[i];
                const card = createMatchCard(match);
                card.style.zIndex = matches.length - i;
                if (i > 0) {
                    card.style.transform = `translateY(${i * 10}px) scale(0.95)`;
                    card.style.opacity = 0.8 - (i * 0.1);
                }
                container.appendChild(card);
            }
        }

        // Main swipe function
        async function performSwipe(direction) {
            if (matches.length === 0) return;
            
            const topCard = container.querySelector('.match-card:last-child'); // The last one added is the top one visually
            if (!topCard) return;

            const targetUserId = topCard.dataset.userId;

            // 1. Animate/move the card
            const screenWidth = window.innerWidth;
            const xOffset = direction === 'right' ? screenWidth : -screenWidth;
            topCard.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
            topCard.style.transform = `translateX(${xOffset}px) rotate(${direction === 'right' ? 10 : -10}deg)`;
            topCard.style.opacity = 0;

            // 2. Send swipe to backend
            try {
                const response = await fetch(`/api/profile/swipe/${targetUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ direction })
                });

                if (response.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const result = await response.json();
                
                if (result.isMatch) {
                    alert(`IT'S A MATCH! You matched with ${matches[currentMatchIndex].username}!`);
                }

            } catch (error) {
                console.error('Error performing swipe:', error);
                // In case of error, you might want to reverse the swipe animation or notify user
            }

            // 3. Remove match from local array and re-render
            setTimeout(() => {
                topCard.remove();
                matches.shift(); // Remove the swiped user from the beginning of the array
                currentMatchIndex = 0; // Resetting index is safer after shift
                renderTopCard();
            }, 500); // Wait for animation to finish
        }


        // Fetch initial matches
        async function fetchMatches() {
            try {
                const response = await fetch('/api/profile/matches');
                
                if (response.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                if (!response.ok) throw new Error('Failed to fetch matches');

                matches = await response.json();
                renderTopCard();

            } catch (error) {
                console.error('Error fetching matches:', error);
                noMatchesDiv.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchMatches);
    </script>
</body>
</html>